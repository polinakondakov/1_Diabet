SegmentWidgets* AddSegmentsDialog::createSegmentWidgets()
{
    auto* widgets = new SegmentWidgets;

    // 1. Создаём контейнер (например, QGroupBox)
    widgets->container = new QGroupBox(tr("Сегмент"));
    auto* layout = new QFormLayout(widgets->container);

    // 2. Создаём и добавляем виджеты
    widgets->typeCombo = new QComboBox();
    widgets->typeCombo->addItems({tr("Равномерное"), tr("Равноускоренное"), tr("Круговое")});
    layout->addRow(tr("Тип движения:"), widgets->typeCombo);

    widgets->durationSpin = new QDoubleSpinBox();
    widgets->durationSpin->setRange(0.0, 1000.0);
    widgets->durationSpin->setValue(5.0);
    layout->addRow(tr("Длительность (с):"), widgets->durationSpin);

    // Поля для начальной позиции
    auto* posLayout = new QHBoxLayout();
    widgets->posXStart = new QDoubleSpinBox(); widgets->posXStart->setRange(-1000000.0, 1000000.0);
    widgets->posYStart = new QDoubleSpinBox(); widgets->posYStart->setRange(-1000000.0, 1000000.0);
    widgets->posZStart = new QDoubleSpinBox(); widgets->posZStart->setRange(-1000000.0, 1000000.0);
    posLayout->addWidget(widgets->posXStart); posLayout->addWidget(widgets->posYStart); posLayout->addWidget(widgets->posZStart);
    layout->addRow(tr("Нач. позиция (X,Y,Z):"), posLayout);

    // Поля для начальной скорости
    auto* velLayout = new QHBoxLayout();
    widgets->velXStart = new QDoubleSpinBox(); widgets->velXStart->setRange(-10000.0, 10000.0);
    widgets->velYStart = new QDoubleSpinBox(); widgets->velYStart->setRange(-10000.0, 10000.0);
    widgets->velZStart = new QDoubleSpinBox(); widgets->velZStart->setRange(-10000.0, 10000.0);
    velLayout->addWidget(widgets->velXStart); velLayout->addWidget(widgets->velYStart); velLayout->addWidget(widgets->velZStart);
    layout->addRow(tr("Нач. скорость (X,Y,Z):"), velLayout);

    // Поля для ускорения (для ACCELERATED)
    auto* accLayout = new QHBoxLayout();
    widgets->accX = new QDoubleSpinBox(); widgets->accX->setRange(-1000.0, 1000.0);
    widgets->accY = new QDoubleSpinBox(); widgets->accY->setRange(-1000.0, 1000.0);
    widgets->accZ = new QDoubleSpinBox(); widgets->accZ->setRange(-1000.0, 1000.0);
    accLayout->addWidget(widgets->accX); accLayout->addWidget(widgets->accY); accLayout->addWidget(widgets->accZ);
    layout->addRow(tr("Ускорение (X,Y,Z):"), accLayout);

    // Поля для центра окружности (для CIRCULAR)
    auto* centerLayout = new QHBoxLayout();
    widgets->centerX = new QDoubleSpinBox(); widgets->centerX->setRange(-1000000.0, 1000000.0);
    widgets->centerY = new QDoubleSpinBox(); widgets->centerY->setRange(-1000000.0, 1000000.0);
    widgets->centerZ = new QDoubleSpinBox(); widgets->centerZ->setRange(-1000000.0, 1000000.0);
    centerLayout->addWidget(widgets->centerX); centerLayout->addWidget(widgets->centerY); centerLayout->addWidget(widgets->centerZ);
    layout->addRow(tr("Центр окр. (X,Y,Z):"), centerLayout);

    // Поле для радиуса (для CIRCULAR)
    widgets->radiusSpin = new QDoubleSpinBox();
    widgets->radiusSpin->setRange(0.0, 10000.0); widgets->radiusSpin->setValue(5.0);
    layout->addRow(tr("Радиус (м):"), widgets->radiusSpin);

    // Поле для угловой скорости (для CIRCULAR)
    widgets->angVelSpin = new QDoubleSpinBox();
    widgets->angVelSpin->setRange(-100.0, 100.0); widgets->angVelSpin->setValue(1.0);
    layout->addRow(tr("Угл. скорость (рад/с):"), widgets->angVelSpin);

    // Скрываем специфичные поля по умолчанию
    accLayout->parentWidget()->setVisible(false); // Скрывает строку с лейблом и лейаутом
    centerLayout->parentWidget()->setVisible(false);
    widgets->radiusSpin->setVisible(false);
    widgets->angVelSpin->setVisible(false);

    // Кнопка удаления
    widgets->removeButton = new QPushButton(tr("Удалить"));
    layout->addRow(widgets->removeButton);

    // Соединяем сигнал clicked кнопки удаления
    connect(widgets->removeButton, &QPushButton::clicked, this, [this, widgets]() {
        int index = segmentWidgetsList.indexOf(widgets);
        if (index != -1) {
            ui->verticalLayoutSegments->removeWidget(widgets->container);
            segmentWidgetsList.removeAt(index);
            delete widgets->container; // Удаляет все дочерние виджеты
            delete widgets; // Удаляет структуру
        }
    });

    // Соединяем сигнал изменения типа движения
    connect(widgets->typeCombo, QOverload<int>::of(&QComboBox::currentIndexChanged),
            this, [this, widgets](int index) {
        // ПОКА НЕ ВЫЗЫВАЕМ updateSegmentFields
        // updateSegmentFields(widgets);
    });

    // Инициализируем видимость полей (все скрыты, кроме общих)
    // updateSegmentFields(widgets); // ПОКА НЕ ВЫЗЫВАЕМ

    return widgets;
}
